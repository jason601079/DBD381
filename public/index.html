<!DOCTYPE html>
<html>
<head>
  <title>Insert Order</title>

  <link rel="stylesheet" href="style.css">
</head>
<body>
  

  <header>
    <h2 id="welcome">Welcome</h2>

    
  <!-- Update Password Section -->
  <input type="password" id="newPassword" placeholder="New Password" style="margin-left: 5px;">
  <button id="updatePasswordBtn" onclick="updatePassword()">Update Password</button>

  <!-- Delete Account Button -->
  <button id="deleteAccountBtn" style="margin-left: 10px; background-color: red; color: white;" onclick="deleteUserAccount()">
    Delete Account
  </button>

    <button id="cartBtn">ðŸ›’ Cart</button>
    
  </header>

  <div class="product-container" id="productList"></div>

  <!-- Cart Sidebar -->
  <div id="cartSidebar">
    <span id="closeCart">X</span>
    <h3>Your Cart</h3>
    <div id="cartItemsContainer"></div>
    <p><strong>Total: R<span id="cartTotal">0.00</span></strong></p>
    <button id="checkoutBtn" onclick="insertOrder()">Checkout</button>
  </div>

</body>

<script >
  const userId = localStorage.getItem('userId');
    const welcomeEl = document.getElementById('welcome');

  if (userId) {
    welcomeEl.textContent = `Welcome, ${userId}`;
  } else {
    alert("You must log in first.");
    window.location.href = "/";
  }

   const products = [
    { _id: "3e41ee2b181545dba25236d0", name: "Heart burn", price: 299.99, Image: "images/bombay-sapphire-london-dry-gin-134503.webp" },
    { _id: "7da62b65ac724412b5b4e750", name: "H***y juice", price: 49.99, Image: "/images/images (1).jpg" },
    { _id: "139d1c76783641a1a415bd03", name: "Blackie", price: 19.99, Image: "/images/images (2).jpg" },
    { _id: "c5c4d28845444ba299b4d170", name: "OG", price: 219.99, Image: "images/wp-image-31449816432823.webp" },
    { _id: "fd204bc272cb4682b6404c3a", name: "Bron Bron", price: 499.99, Image: "images/images.jpg" },
    { _id: "a5a84afa69fd4ab39d90d80a", name: "Medicine", price: 249.99, Image: "images/wp-image-31649110196407.jpg" },
    { _id: "a92ef9b56075471f8c5dacdd", name: "#1 Seller", price: 149.99, Image: "images/wp-image-32072254783671.webp" },
    { _id: "e80b2c93b0614c1aaecc4a2f", name: "Jamey", price: 349.99, Image: "images/wp-image32833255801015-scaled-1.webp" },
    { _id: "51cf92c07b9144e68ff4133b", name: "Another Heart burn", price: 289.99, Image: "images/images (3).jpg" },
    { _id: "4e169fd1049942fba7b77f6e", name: "Juice", price: 179.99, Image: "images/images (4).jpg" }
  ];

  const productList = document.getElementById("productList");
  const cartItems = [];
  const cartSidebar = document.getElementById("cartSidebar");
  const cartItemsContainer = document.getElementById("cartItemsContainer");
  const cartTotal = document.getElementById("cartTotal");

  // Create product cards
  products.forEach(product => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img src="${product.Image}" alt="${product.name}">
      <h3>${product.name}</h3>
      <p>Price: R${product.price.toFixed(2)}</p>
      <input type="number" min="1" value="1" id="qty-${product._id}">
      <button id="btn-${product._id}">Add to Cart</button>
    `;
    productList.appendChild(card);

    const button = card.querySelector(`#btn-${product._id}`);
    button.addEventListener("click", () => {
      const qtyInput = document.getElementById(`qty-${product._id}`);
      const quantity = parseInt(qtyInput.value);

      if (quantity < 1 || isNaN(quantity)) {
        alert("Please enter a valid quantity.");
        return;
      }

      const existing = cartItems.find(item => item.id === product._id);
      if (existing) {
        existing.quantity += quantity;
        existing.subtotal = +(existing.quantity * existing.unitPrice).toFixed(2);
      } else {
        cartItems.push({
          id: product._id,
          name: product.name,
          unitPrice: product.price,
          quantity: quantity,
          subtotal: +(product.price * quantity).toFixed(2)
        });
      }

      updateCartSidebar();
    });
  });

  // Cart UI handlers
  document.getElementById("cartBtn").addEventListener("click", () => {
    cartSidebar.classList.add("active");
  });

  document.getElementById("closeCart").addEventListener("click", () => {
    cartSidebar.classList.remove("active");
  });

  function updateCartSidebar() {
    cartItemsContainer.innerHTML = "";
    let total = 0;

    cartItems.forEach(item => {
      total += item.subtotal;

      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        <strong>${item.name}</strong><br>
        Qty: ${item.quantity} | R${item.subtotal.toFixed(2)}
      `;
      cartItemsContainer.appendChild(div);
    });

    cartTotal.textContent = total.toFixed(2);
}

function insertOrder() {        
    if (cartItems.length === 0) {
     alert("Your cart is empty.");
     return;
    }

    const order = {        
     userId: userId,
     items: cartItems.map(item => ({
       productId: item.id,
       name: item.name,
       price: item.unitPrice,
       quantity: item.quantity
     })),
     total: cartItems.reduce((acc, item) => acc + item.subtotal, 0),
     status: "pending",
     createdAt: new Date().toISOString()
   };        

     fetch('http://localhost:3000/add-order', {
   method: 'POST',
   headers: {
     'Content-Type': 'application/json'
   },
   body: JSON.stringify(order)
     })
  .then(res => res.json())
  .then(data => alert(data.message))
  .catch(err => alert('Error: ' + err.message));
 }

 async function updatePassword() {
  const userId = localStorage.getItem("userId");
  const newPassword = document.getElementById("newPassword").value.trim();

  if (!userId) {
    alert("User not logged in.");
    return;
  }

  if (!newPassword) {
    alert("Please enter a new password.");
    return;
  }

  try {
    const response = await fetch(`/update-password/${userId}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ newPassword })
    });

    const result = await response.json();

    if (response.ok) {
      alert(result.message);
      document.getElementById("newPassword").value = "";
    } else {
      alert(result.message || "Password update failed.");
    }
  } catch (error) {
    console.error("Update error:", error);
    alert("An error occurred while updating the password.");
  }
}

async function deleteUserAccount() {
  const userId = localStorage.getItem('userId');

  if (!userId) {
    alert('User not logged in.');
    return;
  }

  const confirmed = confirm('Are you sure you want to delete your account? This action cannot be undone.');
  if (!confirmed) return;

  try {
    const response = await fetch(`/delete-user/${userId}`, {
      method: 'DELETE',
    });

    const result = await response.json();

    if (response.ok) {
      alert(result.message);
      // Clear user data from localStorage and maybe redirect to login page
      localStorage.removeItem('userId');
      window.location.href = '/user.html';  
    } else {
      alert(result.message || 'Failed to delete account.');
    }
  } catch (error) {
    console.error('Delete error:', error);
    alert('An error occurred while deleting the account.');
  }
}


</script>
</html>
