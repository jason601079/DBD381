<!DOCTYPE html>
<html>
<head>
  <title>Insert Order</title>

  <link rel="stylesheet" href="style.css">
</head>
<body>
  

  <header>
    <h2 id="welcome">Welcome</h2>
    <button id="cartBtn">ðŸ›’ Cart</button>
  </header>

  <div class="product-container" id="productList"></div>

  <!-- Cart Sidebar -->
  <div id="cartSidebar">
    <span id="closeCart">X</span>
    <h3>Your Cart</h3>
    <div id="cartItemsContainer"></div>
    <p><strong>Total: R<span id="cartTotal">0.00</span></strong></p>
    <button id="checkoutBtn" onclick="insertOrder()">Checkout</button>
  </div>

</body>

<script >
  const userId = localStorage.getItem('userId');
    const welcomeEl = document.getElementById('welcome');

  if (userId) {
    welcomeEl.textContent = `Welcome, ${userId}`;
  } else {
    alert("You must log in first.");
    window.location.href = "/";
  }

   const products = [
    { _id: "3e41ee2b181545dba25236d0", name: "Product 1", price: 111.08, imageUrl: "https://example.com/product1.png" },
    { _id: "7da62b65ac724412b5b4e750", name: "Product 2", price: 304.66, imageUrl: "https://example.com/product2.png" },
    { _id: "139d1c76783641a1a415bd03", name: "Product 3", price: 19.93, imageUrl: "https://example.com/product3.png" },
    { _id: "c5c4d28845444ba299b4d170", name: "Product 4", price: 338.83, imageUrl: "https://example.com/product4.png" },
    { _id: "fd204bc272cb4682b6404c3a", name: "Product 5", price: 250.18, imageUrl: "https://example.com/product5.png" },
    { _id: "a5a84afa69fd4ab39d90d80a", name: "Product 6", price: 224.65, imageUrl: "https://example.com/product6.png" },
    { _id: "a92ef9b56075471f8c5dacdd", name: "Product 7", price: 409.60, imageUrl: "https://example.com/product7.png" },
    { _id: "e80b2c93b0614c1aaecc4a2f", name: "Product 8", price: 398.91, imageUrl: "https://example.com/product8.png" },
    { _id: "51cf92c07b9144e68ff4133b", name: "Product 9", price: 289.75, imageUrl: "https://example.com/product9.png" },
    { _id: "4e169fd1049942fba7b77f6e", name: "Product 10", price: 369.53, imageUrl: "https://example.com/product10.png" }
  ];

  const productList = document.getElementById("productList");
  const cartItems = [];
  const cartSidebar = document.getElementById("cartSidebar");
  const cartItemsContainer = document.getElementById("cartItemsContainer");
  const cartTotal = document.getElementById("cartTotal");

  // Create product cards
  products.forEach(product => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img src="${product.imageUrl}" alt="${product.name}">
      <h3>${product.name}</h3>
      <p>Price: R${product.price.toFixed(2)}</p>
      <input type="number" min="1" value="1" id="qty-${product._id}">
      <button id="btn-${product._id}">Add to Cart</button>
    `;
    productList.appendChild(card);

    const button = card.querySelector(`#btn-${product._id}`);
    button.addEventListener("click", () => {
      const qtyInput = document.getElementById(`qty-${product._id}`);
      const quantity = parseInt(qtyInput.value);

      if (quantity < 1 || isNaN(quantity)) {
        alert("Please enter a valid quantity.");
        return;
      }

      const existing = cartItems.find(item => item.id === product._id);
      if (existing) {
        existing.quantity += quantity;
        existing.subtotal = +(existing.quantity * existing.unitPrice).toFixed(2);
      } else {
        cartItems.push({
          id: product._id,
          name: product.name,
          unitPrice: product.price,
          quantity: quantity,
          subtotal: +(product.price * quantity).toFixed(2)
        });
      }

      updateCartSidebar();
    });
  });

  // Cart UI handlers
  document.getElementById("cartBtn").addEventListener("click", () => {
    cartSidebar.classList.add("active");
  });

  document.getElementById("closeCart").addEventListener("click", () => {
    cartSidebar.classList.remove("active");
  });

  function updateCartSidebar() {
    cartItemsContainer.innerHTML = "";
    let total = 0;

    cartItems.forEach(item => {
      total += item.subtotal;

      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        <strong>${item.name}</strong><br>
        Qty: ${item.quantity} | R${item.subtotal.toFixed(2)}
      `;
      cartItemsContainer.appendChild(div);
    });

    cartTotal.textContent = total.toFixed(2);
}

function insertOrder() {
        
  
    if (cartItems.length === 0) {
     alert("Your cart is empty.");
     return;
    }

    const order = {        
     userId: userId,
     items: cartItems.map(item => ({
       productId: item.id,
       name: item.name,
       price: item.unitPrice,
       quantity: item.quantity
     })),
     total: cartItems.reduce((acc, item) => acc + item.subtotal, 0),
     status: "pending",
     createdAt: new Date().toISOString()
   };        

     fetch('http://localhost:3000/add-order', {
   method: 'POST',
   headers: {
     'Content-Type': 'application/json'
   },
   body: JSON.stringify(order)
     })
  .then(res => res.json())
  .then(data => alert(data.message))
  .catch(err => alert('Error: ' + err.message));
 }

</script>
</html>
